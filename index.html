<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bread Sales Dashboard</title>

  <!-- Appwrite SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9fafb; color: #1f2937; }
    h1 { text-align: center; color: #265DAB; }
    .tabs { display: flex; margin-top: 20px; border-bottom: 2px solid #e5e7eb; }
    .tab-button {
      padding: 10px 15px;
      border: none;
      background-color: transparent;
      font-weight: bold;
      cursor: pointer;
      color: #6b7280;
      border-bottom: 2px solid transparent;
    }
    .tab-button.active {
      color: #265DAB;
      border-bottom: 2px solid #265DAB;
    }
    .tab-content { display: none; margin-top: 20px; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background-color: #265DAB; color: white; }
    .copy-buttons { text-align: right; margin-top: 10px; }
    .copy-buttons button {
      background-color: #059669;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .copy-buttons button:hover { opacity: 0.9; }
    select, button { margin: 10px 0; padding: 6px; font-size: 14px; }
    .chart-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    .chart-box {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      height: 350px;
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    .chart-box h3 {
      margin-top: 0;
      color: #265DAB;
      font-size: 16px;
      margin-bottom: 10px;
    }
    .chart-box canvas {
      flex: 1;
    }
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
      justify-content: center;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .chart-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .chart-row {
        flex-direction: column;
      }
      
      .chart-box {
        height: 350px;
      }
    }
    
    /* Date and User selection panel styles */
    .selection-panel {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
    }
    
    .selection-step {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .selection-step select, .selection-step button {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .step-number {
      display: inline-block;
      width: 24px;
      height: 24px;
      background-color: #265DAB;
      color: white;
      border-radius: 50%;
      text-align: center;
      font-weight: bold;
      line-height: 24px;
      margin-right: 5px;
    }
    
    /* Make selections more responsive */
    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .selection-panel {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .selection-step {
        width: 100%;
        margin-bottom: 10px;
      }
    }
    
    /* Expandable cell styles */
    .expandable-cell {
      position: relative;
      min-width: 200px;
    }
    
    .toggle-btn {
      font-size: 12px;
      padding: 2px 6px;
      margin-left: 5px;
      background-color: #265DAB;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .toggle-btn:hover {
      opacity: 0.9;
    }
    
    .preview-content {
      display: inline-block;
    }
    
    .full-content {
      word-break: break-word;
    }

    /* Custom dropdown styles */
    .custom-dropdown { position: relative; display: inline-block; }
    .custom-dropdown .dropdown-toggle {
      padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: #fff; cursor: pointer; white-space: nowrap;
    }
    .custom-dropdown .dropdown-menu {
      position: absolute; top: 100%; left: 0; z-index: 50; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-height: 260px; overflow-y: auto; width: max-content; min-width: 0; margin-top: 6px; white-space: nowrap;
    }
    .custom-dropdown .dropdown-item { padding: 8px 12px; cursor: pointer; white-space: nowrap; }
    .custom-dropdown .dropdown-item:hover { background: #f3f4f6; }
    .custom-dropdown .dropdown-separator { padding: 0; margin: 4px 0; border: 0; border-top: 5px solid #e5e7eb; }
    .custom-dropdown .dropdown-load-more { font-weight: 700; color: #265DAB; }

    /* Add these new styles */
    select {
      max-height: 200px;
      overflow-y: auto;
    }
    
    /* Date dropdown specific styles */
    #dateSelect {
      max-height: 200px;
      overflow-y: auto;
      width: auto;
      min-width: 120px;
    }
    
    /* Table resizing styles */
    table {
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
    }
    
    th, td {
      position: relative;
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    th {
      background-color: #265DAB;
      color: white;
      user-select: none;
    }
    
    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      background: #265DAB;
      cursor: col-resize;
    }
    
    .resizer:hover {
      background: #1e4b8f;
    }
    
    /* Remove expandable cell styles */
    .expandable-cell {
      position: relative;
      min-width: 200px;
    }
    
    .toggle-btn {
      display: none;
    }
    
    .preview-content {
      display: none;
    }
    
    .full-content {
      display: inline-block;
    }

    /* Search controls styles */
    .search-controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .search-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s ease;
      background: #f9fafb;
    }

    .search-input:focus {
      outline: none;
      border-color: #265DAB;
      background: white;
      box-shadow: 0 0 0 3px rgba(38, 93, 171, 0.1);
    }

    .clear-search-btn {
      padding: 12px 20px;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .clear-search-btn:hover {
      background: #4b5563;
    }

    .search-stats {
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
    }

    /* Customer tab styles */
    .customer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      padding: 20px 0;
    }

    .customer-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .customer-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #265DAB, #3B82F6, #8B5CF6);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .customer-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border-color: #265DAB;
    }

    .customer-card:hover::before {
      transform: scaleX(1);
    }

    .customer-header {
      margin-bottom: 20px;
      text-align: left;
    }

    .customer-header h3 {
      margin: 0 0 8px 0;
      color: #1e293b;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .customer-name {
      color: #64748b;
      font-size: 16px;
      font-weight: 500;
      display: block;
      margin-bottom: 0;
    }

    .customer-info {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .info-item {
      text-align: center;
      padding: 12px 8px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .info-value {
      display: block;
      font-size: 18px;
      font-weight: 700;
      color: #265DAB;
      margin-bottom: 4px;
    }

    .info-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .customer-footer {
      text-align: center;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .click-hint {
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
      opacity: 0.8;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    }

    /* Receipt History Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .modal-header {
      padding: 24px 24px 16px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      color: #265DAB;
      font-size: 24px;
      font-weight: bold;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-body {
      padding: 24px;
    }

    .receipt-list {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .receipt-item {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .receipt-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #265DAB, #3B82F6);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

         /* Remove hover effects - only show highlight when expanded */
     .receipt-item:hover {
       /* No hover effects */
     }

     .receipt-item:hover::before {
       /* No hover effects */
     }

     /* Expanded state styling - similar to hover but permanent */
     .receipt-item.expanded {
       border-color: #265DAB;
       box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.06);
       transform: translateY(-2px);
     }

     .receipt-item.expanded::before {
       transform: scaleX(1);
     }

     /* Remove hover effects when expanded */
     .receipt-item.expanded:hover {
       border-color: #265DAB;
       box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.06);
       transform: translateY(-2px);
     }

    .receipt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f1f5f9;
    }

    .receipt-date {
      font-weight: 700;
      color: #1e293b;
      font-size: 18px;
    }

    .receipt-amount {
      font-size: 20px;
      font-weight: 700;
      color: #059669;
      background: rgba(5, 150, 105, 0.1);
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid rgba(5, 150, 105, 0.2);
    }
    
    .receipt-amount.negative {
      color: #dc2626;
      background: rgba(220, 38, 38, 0.1);
      border-color: rgba(220, 38, 38, 0.2);
    }

    .receipt-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      padding: 12px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .detail-label {
      font-weight: 600;
      color: #64748b;
      margin-bottom: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      color: #1e293b;
      font-weight: 600;
      font-size: 14px;
    }

    .receipt-items {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #f1f5f9;
    }

    .items-label {
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 12px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .items-label::before {
      content: 'üì¶';
      font-size: 16px;
    }

         .items-list {
       background: #f8fafc;
       border-radius: 12px;
       padding: 16px;
       margin-bottom: 16px;
     }

     .item-row {
       display: flex;
       justify-content: space-between;
       align-items: center;
       padding: 8px 0;
       border-bottom: 1px solid #e2e8f0;
       font-size: 14px;
     }

     .item-row:last-child {
       border-bottom: none;
     }

     .item-name {
       font-weight: 600;
       color: #1e293b;
       flex: 1;
     }

     .item-qty {
       background: rgba(59, 130, 246, 0.15);
       color: #1e40af;
       padding: 4px 8px;
       border-radius: 6px;
       font-weight: 600;
       font-size: 12px;
       text-align: center;
       min-width: 40px;
       margin: 0 12px;
     }

     .item-total {
       background: rgba(5, 150, 105, 0.15);
       color: #047857;
       padding: 4px 8px;
       border-radius: 6px;
       font-weight: 700;
       font-size: 12px;
       text-align: center;
       min-width: 70px;
     }

     .order-section {
       border-left: 4px solid #10b981;
       background: rgba(16, 185, 129, 0.02);
     }

     .return-section {
       border-left: 4px solid #ef4444;
       background: rgba(239, 68, 68, 0.02);
     }

     .order-section .items-label {
       color: #047857;
     }

     .return-section .items-label {
       color: #dc2626;
     }

    .receipt-totals {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      border: 2px solid #e2e8f0;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 15px;
      padding: 8px 0;
    }

    .totals-row:last-child {
      margin-bottom: 0;
      padding-top: 16px;
      border-top: 2px solid #e2e8f0;
      font-weight: 700;
      font-size: 18px;
      color: #265DAB;
    }

    .totals-label {
      color: #64748b;
      font-weight: 600;
    }

    .totals-value {
      font-weight: 700;
      color: #1e293b;
    }
    
    .totals-value.negative {
      color: #dc2626;
    }

    .expandable-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .expandable-content.expanded {
      max-height: 2000px;
    }

    .no-receipts {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    }

         /* Toggle Switch Spacing */
     .toggle-switch {
       margin-left: 16px;
     }

     /* Toggle Switch Styles */
     .toggle-switch {
       display: inline-flex;
       align-items: center;
       gap: 8px;
       cursor: pointer;
       user-select: none;
       font-size: 14px;
       font-weight: 500;
       color: #374151;
       vertical-align: middle;
     }

     .toggle-switch input[type="checkbox"] {
       display: none;
     }

     .switch-slider {
       position: relative;
       width: 44px;
       height: 24px;
       background-color: #d1d5db;
       border-radius: 12px;
       transition: background-color 0.2s ease;
     }

     .switch-slider:before {
       content: '';
       position: absolute;
       top: 2px;
       left: 2px;
       width: 20px;
       height: 20px;
       background-color: white;
       border-radius: 50%;
       transition: transform 0.2s ease;
       box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
     }

     .toggle-switch input[type="checkbox"]:checked + .switch-slider {
       background-color: #265DAB;
     }

     .toggle-switch input[type="checkbox"]:checked + .switch-slider:before {
       transform: translateX(20px);
     }

     .switch-label {
       font-size: 13px;
       font-weight: 500;
       color: #6b7280;
     }
     
     /* Hover effects for toggle switch */
     .toggle-switch:hover .switch-slider {
       background-color: #9ca3af;
     }
     
     .toggle-switch:hover input[type="checkbox"]:checked + .switch-slider {
       background-color: #1e40af;
     }
     
     /* Focus styles for accessibility */
     .toggle-switch input[type="checkbox"]:focus + .switch-slider {
       box-shadow: 0 0 0 3px rgba(38, 93, 171, 0.1);
     }

     /* Responsive design for customer grid */
     @media (max-width: 768px) {
      .search-controls {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .search-input-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-input {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .toggle-switch {
        margin-left: 8px;
        margin-top: 8px;
      }
      
      .customer-grid {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 15px 0;
      }
      
      .customer-card {
        padding: 15px;
      }

      .modal-content {
        margin: 10px;
        max-height: 95vh;
      }

      .modal-header {
        padding: 16px;
      }

      .modal-body {
        padding: 16px;
      }

      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .receipt-details {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
  </style>
</head>
<body>

  <div style="background-color: #FEF3C7; color: #92400E; padding: 10px; margin-bottom: 20px; border-radius: 5px; display: none;" id="corsWarning">
    ‚ö†Ô∏è This page must be accessed through a web server (e.g., http://localhost:8080) and not opened directly as a file.
  </div>

  <h1>Bread Sales Dashboard</h1>

  <div class="selection-panel">
    <div class="selection-step">
      <span class="step-number">1</span>
      <label for="dateSelect">Select a date:</label>
      <select id="dateSelect" style="display:none;"></select>
      <div class="custom-dropdown" id="dateDropdown">
        <button type="button" class="dropdown-toggle" id="dateDropdownButton">Select a date</button>
        <div class="dropdown-menu" id="dateDropdownMenu" style="display:none;"></div>
      </div>
    </div>
    
    <div class="selection-step" id="userIdStep" style="display: none;">
      <span class="step-number">2</span>
      <label for="userIdSelect">Select a user:</label>
      <select id="userIdSelect"></select>
    </div>
  </div>

  <div id="status" style="color: #265DAB; margin: 10px 0;"></div>

  <div class="tabs">
    <button class="tab-button active" data-tab="csv">üì¶ Inventory & CSV</button>
    <button class="tab-button" data-tab="sales">üßæ Customer Sales</button>
    <button class="tab-button" data-tab="charts">üìä Charts</button>
    <button class="tab-button" data-tab="customers">üë• Customers</button>
  </div>

  <div class="copy-buttons">
    <button class="copy-button" data-tab="csv">üì• Download CSV Data</button>
    <label class="toggle-switch" data-tab="sales" style="display:none;">
      <input type="checkbox" id="showCustomerNames">
      <span class="switch-slider"></span>
      <span class="switch-label">Show Customer Names</span>
    </label>
    <button class="copy-button" data-tab="sales" style="display:none;">üì• Download Sales Data</button>
  </div>

  <div id="csv" class="tab-content active">
    <div id="csvContent">Please select a date and user to load CSV...</div>
  </div>

     <div id="sales" class="tab-content">
     <div id="salesContent">
       <div id="salesTableContent">Please select a date and user to load Sales...</div>
     </div>
   </div>

  <div id="charts" class="tab-content">
    <div id="chartsContent">
      <div class="chart-container">
        <div class="chart-box">
          <h3>Sales Overview by Bread Type</h3>
          <canvas id="salesOverviewChart"></canvas>
        </div>
        
        <div class="chart-box">
          <h3>Inventory Management</h3>
          <canvas id="inventoryChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div id="customers" class="tab-content">
    <div id="customersContent">
      <div class="search-controls">
        <div class="search-input-group">
          <input type="text" id="customerSearch" placeholder="Search by store name or customer name..." class="search-input">
          <button id="clearSearch" class="clear-search-btn" style="display: none;">Clear</button>
        </div>
        <div class="search-stats">
          <span id="searchResultsCount"></span>
        </div>
      </div>
      <div class="customer-grid" id="customerGrid">
        <div class="loading">Loading customers...</div>
      </div>
    </div>
  </div>

  <!-- Receipt History Modal -->
  <div id="receiptModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Receipt History</h2>
        <button class="modal-close" onclick="closeReceiptModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <script type="module">
    // Import customer configuration and service
    import { customerConfig } from './customerConfig.js';
    import { CustomerService } from './customerService.js';

    // Initialize customer service
    const customerService = new CustomerService();
    
    // Global variable to store all customers for search functionality
    let allCustomers = [];

    if (window.location.protocol === 'file:') {
      document.getElementById('corsWarning').style.display = 'block';
    }

    // ‚úÖ Appwrite Setup
    const client = new Appwrite.Client();
    client.setEndpoint('https://cloud.appwrite.io/v1').setProject('676a55320025aab57b76');
    const databases = new Appwrite.Databases(client);
    const databaseId = '676a5743003e13f9398d';
    const csvCollection = 'CSV';
    const salesCollection = 'sales';

    // Elements
    const dateSelect = document.getElementById('dateSelect');
    const dateDropdown = document.getElementById('dateDropdown');
    const dateDropdownBtn = document.getElementById('dateDropdownButton');
    const dateDropdownMenu = document.getElementById('dateDropdownMenu');
    const userIdSelect = document.getElementById('userIdSelect');
    const userIdStep = document.getElementById('userIdStep');
    const csvContent = document.getElementById('csvContent');
    const chartsContent = document.getElementById('chartsContent');
    const statusElement = document.getElementById('status');

    // Chart instances
    let salesOverviewChart = null;
    let inventoryChart = null;

    // Display status messages
    function showStatus(message, isError = false) {
      statusElement.innerHTML = message;
      statusElement.style.color = isError ? '#DC2626' : '#265DAB';
      console.log(isError ? `ERROR: ${message}` : message);
    }

    // Function to add copy naming convention button
    function setupCopyNamingButton() {
      const copyNamingBtn = document.createElement('button');
      copyNamingBtn.textContent = 'üìã Copy Naming Convention';
      copyNamingBtn.style.backgroundColor = '#F59E0B';
      copyNamingBtn.style.color = 'white';
      copyNamingBtn.style.border = 'none';
      copyNamingBtn.style.borderRadius = '5px';
      copyNamingBtn.style.padding = '8px 12px';
      copyNamingBtn.style.margin = '0 10px';
      
      document.querySelector('.selection-panel').appendChild(copyNamingBtn);
      
      copyNamingBtn.addEventListener('click', function() {
        const selectedDate = dateSelect.value;
        const selectedUser = userIdSelect.value;
        
        if (!selectedDate || !selectedUser) {
          showStatus("Please select both a date and user first", true);
          return;
        }
        
        // Format date for naming convention (MM-DD-YY)
        const formattedDate = formatDateForFilename(selectedDate);
        const namingConvention = `${formattedDate} _ ${selectedUser}`;
        
        // Copy to clipboard
        navigator.clipboard.writeText(namingConvention).then(() => {
          showStatus(`Copied naming convention: ${namingConvention}`);
        }).catch(err => {
          console.error('Failed to copy: ', err);
          showStatus("Failed to copy to clipboard", true);
        });
      });

      // Add Download Customers button
      const downloadCustomersBtn = document.createElement('button');
      downloadCustomersBtn.textContent = 'üì• Download Customers';
      downloadCustomersBtn.style.backgroundColor = '#265DAB';
      downloadCustomersBtn.style.color = 'white';
      downloadCustomersBtn.style.border = 'none';
      downloadCustomersBtn.style.borderRadius = '5px';
      downloadCustomersBtn.style.padding = '8px 12px';
      downloadCustomersBtn.style.margin = '0 10px';
      
      document.querySelector('.selection-panel').appendChild(downloadCustomersBtn);
      
      downloadCustomersBtn.addEventListener('click', async function() {
        try {
          showStatus("Fetching customer data...");
          
          // Function to fetch all customers with pagination
          async function fetchAllCustomers() {
            let allCustomers = [];
            let offset = 0;
            const limit = 100; // Fetch in batches of 100
            
            while (true) {
              const response = await databases.listDocuments(
                databaseId,
                'customers',
                [
                  Appwrite.Query.limit(limit),
                  Appwrite.Query.offset(offset)
                ]
              );
              
              allCustomers = allCustomers.concat(response.documents);
              
              // If we got less than the limit, we've reached the end
              if (response.documents.length < limit) {
                break;
              }
              
              offset += limit;
            }
            
            return allCustomers;
          }
          
          // Fetch all customers
          const customers = await fetchAllCustomers();
          
          if (customers.length === 0) {
            showStatus("No customers found", true);
            return;
          }
          
          // Create CSV content
          const headers = ['Customer ID', 'Name', 'Store Name', 'Address', 'Phone Number', 'Schedule'];
          const rows = customers.map(customer => [
            customer.customerId || '',
            customer.name || '',
            customer.storeName || '',
            customer.address || '',
            customer.phoneNumber || '',
            customer.schedule || ''
          ]);
          
          // Combine headers and rows
          const textContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
          ].join('\n');
          
          // Generate filename
          const filename = 'customers.txt';
          
          // Download the file
          downloadTextFile(textContent, filename);
          
          showStatus(`Downloaded ${customers.length} customers successfully`);
        } catch (error) {
          console.error("Error downloading customers:", error);
          showStatus(`Error downloading customers: ${error.message}`, true);
        }
      });
    }

    // Helper function to format date as MM-DD-YY
    function formatDateForDisplay(dateString) {
      const date = new Date(dateString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2); // Get last 2 digits of year
      return `${month}-${day}-${year}`;
    }

    // Helper function to format date for filename
    function formatDateForFilename(dateString) {
      const date = new Date(dateString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2); // Get last 2 digits of year
      return `${month}-${day}-${year}`;
    }

    // Global variables for date pagination
    let allAvailableDates = [];
    let currentDateOffset = 0;
    const datesPerPage = 10;
    // Server-side pagination trackers
    let csvPageOffset = 0;
    let salesPageOffset = 0;
    const fetchBatchLimit = 100;
    let csvHasMore = false;
    let salesHasMore = false;

    async function getAvailableDates() {
      showStatus("Fetching available dates...");
      
      try {
        console.log("Starting date fetch process...");
        
        // Reset server-side pagination trackers
        csvPageOffset = 0;
        salesPageOffset = 0;
        csvHasMore = false;
        salesHasMore = false;

        // Fetch documents with a reasonable limit
        console.log("Fetching CSV documents...");
        const csvDocs = await databases.listDocuments(databaseId, csvCollection, [
          Appwrite.Query.orderDesc("date"),
          Appwrite.Query.limit(fetchBatchLimit),
          Appwrite.Query.offset(csvPageOffset)
        ]);
        console.log("CSV documents received:", csvDocs);
        
        console.log("Fetching Sales documents...");
        const salesDocs = await databases.listDocuments(databaseId, salesCollection, [
          Appwrite.Query.orderDesc("date"),
          Appwrite.Query.limit(fetchBatchLimit),
          Appwrite.Query.offset(salesPageOffset)
        ]);
        console.log("Sales documents received:", salesDocs);
        
        // Log the raw dates from each collection
        const csvDates = csvDocs.documents.map(doc => doc.date);
        const salesDates = salesDocs.documents.map(doc => doc.date);
        console.log("Raw CSV dates:", csvDates);
        console.log("Raw Sales dates:", salesDates);
        
        // Combine and deduplicate dates
        allAvailableDates = [...new Set([...csvDates, ...salesDates])];
        console.log("All unique dates before sorting:", allAvailableDates);
        
        // Sort dates in descending order
        allAvailableDates.sort((a, b) => new Date(b) - new Date(a));
        console.log("All unique dates after sorting:", allAvailableDates);
        
        // Reset pagination and initialize server-side pagination trackers
        currentDateOffset = 0;
        csvPageOffset += csvDocs.documents.length;
        salesPageOffset += salesDocs.documents.length;
        csvHasMore = csvDocs.documents.length === fetchBatchLimit;
        salesHasMore = salesDocs.documents.length === fetchBatchLimit;
        
        if (allAvailableDates.length === 0) {
          console.log("No dates found in any documents");
          showStatus("No dates found. Try using Sample Data button.", true);
          const today = new Date().toISOString().split('T')[0];
          const formattedToday = formatDateForDisplay(today);
          // Seed with today so dropdown works initially
          allAvailableDates = [today];
          currentDateOffset = 0;
          // Reset and populate both native and custom dropdowns
          dateSelect.innerHTML = '<option value="">Select a date</option>';
          dateDropdownMenu.innerHTML = '';
          populateDateDropdown();
        } else {
          console.log(`Found ${allAvailableDates.length} dates, populating select element`);
          populateDateDropdown();
          showStatus(`Found ${allAvailableDates.length} dates`);
        }
      } catch (error) {
        console.error("Error in getAvailableDates:", error);
        console.error("Error details:", {
          message: error.message,
          code: error.code,
          type: error.type,
          response: error.response
        });
        showStatus(`Error fetching dates: ${error.message}`, true);
        const today = new Date().toISOString().split('T')[0];
        // Seed with today on error to keep dropdown usable
        allAvailableDates = [today];
        currentDateOffset = 0;
        dateSelect.innerHTML = '<option value="">Select a date</option>';
        dateDropdownMenu.innerHTML = '';
        populateDateDropdown();
      }
    }

    // Function to populate date dropdown with pagination
    function populateDateDropdown() {
      const startIndex = currentDateOffset;
      const endIndex = Math.min(startIndex + datesPerPage, allAvailableDates.length);
      const datesToShow = allAvailableDates.slice(startIndex, endIndex);
      
      // Clear existing options for initial load only
      if (currentDateOffset === 0) {
        dateSelect.innerHTML = '<option value="">Select a date</option>';
        dateDropdownBtn.textContent = 'Select a date';
        dateDropdownMenu.innerHTML = '';
      }

      // Rebuild menu without closing it
      // Remove existing Load More entry only; keep existing separators in place
      const existingLoadMoreEl = dateDropdownMenu.querySelector('.dropdown-load-more');
      if (existingLoadMoreEl) existingLoadMoreEl.remove();

      // Append the next page of dates to native select and custom menu
      datesToShow.forEach((date, idx) => {
        const formattedDate = formatDateForDisplay(date);
        const option = document.createElement('option');
        option.value = date;
        option.textContent = formattedDate;
        dateSelect.appendChild(option);

        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.textContent = formattedDate;
        item.dataset.value = date;
        item.addEventListener('click', () => {
          dateSelect.value = date;
          dateDropdownBtn.textContent = formattedDate;
          // Trigger change for downstream logic
          dateSelect.dispatchEvent(new Event('change'));
          // Keep menu open only if user clicked Load More; for date selection, close it
          dateDropdownMenu.style.display = 'none';
        });
        dateDropdownMenu.appendChild(item);
      });

      // Insert a separator after each 10-date batch if more dates follow
      const needSeparator = endIndex < allAvailableDates.length;
      if (needSeparator) {
        const sep = document.createElement('hr');
        sep.className = 'dropdown-separator';
        dateDropdownMenu.appendChild(sep);
      }

      // Append a single Load More item if more dates remain locally or on the server
      if (endIndex < allAvailableDates.length || csvHasMore || salesHasMore) {
        const loadMoreEl = document.createElement('div');
        loadMoreEl.className = 'dropdown-item dropdown-load-more';
        loadMoreEl.textContent = 'Load More';
        loadMoreEl.addEventListener('click', async (e) => {
          e.stopPropagation();
          await loadMoreDates();
          // Keep menu open after loading more
          dateDropdownMenu.style.display = 'block';
        });
        dateDropdownMenu.appendChild(loadMoreEl);
      }
    }

    // Function to load more dates
    async function loadMoreDates() {
      const nextOffset = currentDateOffset + datesPerPage;
      // If we need more than we currently have locally, try to fetch more pages from server
      while (nextOffset > allAvailableDates.length && (csvHasMore || salesHasMore)) {
        await fetchMoreDatesFromServer();
      }
      currentDateOffset = Math.min(nextOffset, allAvailableDates.length);
      populateDateDropdown();
      // Keep custom dropdown open
      dateDropdownMenu.style.display = 'block';
    }

    // Fetch additional dates from server in batches and append uniquely
    async function fetchMoreDatesFromServer() {
      try {
        showStatus("Loading more dates...");
        const promises = [];
        if (csvHasMore) {
          promises.push(databases.listDocuments(databaseId, csvCollection, [
            Appwrite.Query.orderDesc('date'),
            Appwrite.Query.limit(fetchBatchLimit),
            Appwrite.Query.offset(csvPageOffset)
          ]));
        } else {
          promises.push(Promise.resolve(null));
        }
        if (salesHasMore) {
          promises.push(databases.listDocuments(databaseId, salesCollection, [
            Appwrite.Query.orderDesc('date'),
            Appwrite.Query.limit(fetchBatchLimit),
            Appwrite.Query.offset(salesPageOffset)
          ]));
        } else {
          promises.push(Promise.resolve(null));
        }

        const [csvRes, salesRes] = await Promise.all(promises);
        const newCsvDates = csvRes ? csvRes.documents.map(doc => doc.date) : [];
        const newSalesDates = salesRes ? salesRes.documents.map(doc => doc.date) : [];

        if (csvRes) {
          csvPageOffset += csvRes.documents.length;
          csvHasMore = csvRes.documents.length === fetchBatchLimit;
        }
        if (salesRes) {
          salesPageOffset += salesRes.documents.length;
          salesHasMore = salesRes.documents.length === fetchBatchLimit;
        }

        // Merge, dedupe, sort desc
        allAvailableDates = [...new Set([...allAvailableDates, ...newCsvDates, ...newSalesDates])];
        allAvailableDates.sort((a, b) => new Date(b) - new Date(a));
        showStatus("More dates loaded");
      } catch (error) {
        console.error('Error loading more dates:', error);
        showStatus(`Error loading more dates: ${error.message}`, true);
        csvHasMore = false;
        salesHasMore = false;
      }
    }

    // New function to fetch users for a selected date
    async function getUsersForDate(date) {
      showStatus(`Fetching users for date: ${date}...`);
      userIdSelect.innerHTML = '<option value="">Loading users...</option>';
      
      try {
        // Get all documents for the selected date from both collections
        const csvQuery = [Appwrite.Query.equal("date", date)];
        const salesQuery = [Appwrite.Query.equal("date", date)];
        
        const csvDocs = await databases.listDocuments(databaseId, csvCollection, csvQuery);
        const salesDocs = await databases.listDocuments(databaseId, salesCollection, salesQuery);
        
        // Extract unique userIds
        const csvUserIds = csvDocs.documents.map(doc => doc.userId);
        const salesUserIds = salesDocs.documents.map(doc => doc.userId);
        const allUserIds = [...new Set([...csvUserIds, ...salesUserIds])];
        
        console.log(`Found ${allUserIds.length} users for date ${date}:`, allUserIds);
        
        if (allUserIds.length === 0) {
          userIdSelect.innerHTML = '<option value="">No users found</option>';
          showStatus(`No users found for date: ${date}`, true);
        } else {
          // Add placeholder option as first option
          userIdSelect.innerHTML = '<option value="">Select a user</option>';
          // Add all users as options
          allUserIds.forEach(userId => {
            userIdSelect.innerHTML += `<option value="${userId}">${userId}</option>`;
          });
          
          showStatus(`Found ${allUserIds.length} users for date: ${date}`);
        }
        
        // Show the user selection step
        userIdStep.style.display = 'flex';
      } catch (error) {
        console.error(`Error fetching users for date ${date}:`, error);
        userIdSelect.innerHTML = '<option value="">Error loading users</option>';
        showStatus(`Error fetching users: ${error.message}`, true);
      }
    }

    async function loadData(date, userId) {
      showStatus(`Loading data for ${date}, User: ${userId}...`);
      csvContent.innerHTML = "Loading CSV...";
      
      const salesTableContent = document.getElementById('salesTableContent');
      if (salesTableContent) {
        salesTableContent.innerHTML = "Loading Sales...";
      }
      
      let csvData = null;
      let salesData = null;
      let expensesData = null;

      // Prepare query - filter by date and userId
      const queries = [
        Appwrite.Query.equal("date", date), 
        Appwrite.Query.equal("userId", userId), 
        Appwrite.Query.limit(1)
      ];

      // -- Fetch CSV -- //
      try {
        showStatus(`Fetching CSV data for ${date}, User: ${userId}...`);
        
        const res = await databases.listDocuments(databaseId, csvCollection, queries);
        
        console.log("CSV query result:", res);
        
        if (res.documents.length === 0) {
          showStatus(`No CSV data found for ${date} and user ${userId}`, true);
          csvContent.innerHTML = `<p>No CSV data available for ${date} and user ${userId}</p>`;
        } else {
          const csvText = res.documents[0]?.CSV_Doc || '';
          
          if (!csvText || csvText.trim() === '') {
            throw new Error("Empty CSV data received from server");
          }
          
          csvContent.innerHTML = prettyPrintCSVTable(csvText);
          setupTableResizing();
          csvData = parseCSVStringToArray(csvText);
          showStatus(`CSV data loaded for ${date}, User: ${userId}`);
        }
      } catch (e) {
        console.error("CSV Error:", e);
        csvContent.innerHTML = `<p style="color:red">CSV Error: ${e.message}</p>`;
        showStatus(`Error loading CSV data: ${e.message}`, true);
      }

             // -- Fetch Sales -- //
       try {
         showStatus(`Fetching Sales data for ${date}, User: ${userId}...`);
         
         const res = await databases.listDocuments(databaseId, salesCollection, queries);
         
         console.log("Sales query result:", res);
         
         if (res.documents.length === 0) {
           showStatus(`No Sales data found for ${date} and user ${userId}`, true);
           const salesTableContent = document.getElementById('salesTableContent');
           if (salesTableContent) {
             salesTableContent.innerHTML = `<p>No Sales data available for ${date} and user ${userId}</p>`;
           }
         } else {
           const salesCSV = res.documents[0]?.receiptSummary || '';
           
           if (!salesCSV || salesCSV.trim() === '') {
             throw new Error("Empty sales data received from server");
           }
           
           salesData = parseCSVStringToArray(salesCSV);
           // Store sales data globally for toggle functionality
           window.currentSalesData = salesData;
           
           const salesTableContent = document.getElementById('salesTableContent');
           console.log('salesTableContent element:', salesTableContent);
           
           if (salesTableContent) {
             salesTableContent.innerHTML = generateSalesTable(salesData);
             setupTableResizing();
             showStatus(`Sales data loaded for ${date}, User: ${userId}`);
           } else {
             console.error('salesTableContent element not found');
             showStatus(`Error: Sales table container not found`, true);
           }
         }
       } catch (e) {
         console.error("Sales Error:", e);
         const salesTableContent = document.getElementById('salesTableContent');
         if (salesTableContent) {
           salesTableContent.innerHTML = `<p style="color:red">Sales Error: ${e.message}</p>`;
         }
         showStatus(`Error loading Sales data: ${e.message}`, true);
       }

      // -- Fetch Expenses -- //
      try {
        showStatus(`Fetching Expenses data for ${date}, User: ${userId}...`);
        
        const expensesRes = await databases.listDocuments(
          databaseId,
          '680476b00037a3775919', // expenses collection ID
          [
            Appwrite.Query.equal("date", date),
            Appwrite.Query.equal("userId", userId)
          ]
        );
        
        console.log("Expenses query result:", expensesRes);
        
        if (expensesRes.documents.length > 0) {
          expensesData = expensesRes.documents.map(doc => ({
            title: doc.title,
            amount: doc.amount,
            note: doc.note || ''
          }));
          showStatus(`Expenses data loaded for ${date}, User: ${userId}`);
        } else {
          expensesData = [];
          showStatus(`No expenses found for ${date} and user ${userId}`);
        }
      } catch (e) {
        console.error("Expenses Error:", e);
        expensesData = [];
        showStatus(`Error loading Expenses data: ${e.message}`, true);
      }

      // -- Update Charts -- //
      if (csvData && csvData.length > 0) {
        updateCharts(csvData, salesData);
        showStatus("Charts updated successfully");
      } else {
        showStatus("No data available for charts", true);
      }

      // Store expenses data in a global variable for download
      window.currentExpensesData = expensesData;
    }

    // Toggle custom dropdown
    dateDropdownBtn.addEventListener('click', () => {
      const isOpen = dateDropdownMenu.style.display === 'block';
      dateDropdownMenu.style.display = isOpen ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!dateDropdown.contains(e.target)) {
        dateDropdownMenu.style.display = 'none';
      }
    });

    // Add event listener to date select to fetch users when date changes
    dateSelect.addEventListener("change", () => {
      const selectedDate = dateSelect.value;
      
      // Handle "Load More" option
      if (selectedDate === 'load_more') {
        loadMoreDates();
        return;
      }
      
      // Reset user selection when date changes
      userIdSelect.innerHTML = '';
      userIdStep.style.display = 'none';
      
      if (selectedDate) {
        getUsersForDate(selectedDate);
      }
    });

    // Updated userIdSelect event listener to automatically load data
    userIdSelect.addEventListener("change", () => {
      const selectedDate = dateSelect.value;
      const selectedUserId = userIdSelect.value;
      
      if (selectedUserId) {
        loadData(selectedDate, selectedUserId);
      }
    });

    // Updated chart function to properly handle chart dimensions
    function updateCharts(csvData, salesData) {
      try {
        let breadData;
        
        if (!csvData || csvData.length < 2) {
          showStatus("Insufficient data for charts", true);
          return;
        }
        
        // Process CSV data for charts and filter out breads with 0 net sales
        breadData = csvData.slice(1, -1)
          .map(row => {
            return {
              name: row[0] || 'Unknown',
              price: parseFloat(row[1]) || 0,
              load: parseInt(row[2]) || 0,
              bo: parseInt(row[3]) || 0,
              returned: parseInt(row[4]) || 0,
              netSaleQty: parseInt(row[5]) || 0,
              netSaleValue: parseFloat(row[6]) || 0
            };
          })
          .filter(bread => bread.netSaleQty > 0); // Only show breads with sales
        
        if (breadData.length === 0) {
          showStatus("No bread data with sales found for charts", true);
          return;
        }
        
        // Define chart colors
        const chartColors = {
          sales: '#3B82F6',    // Blue
          revenue: '#10B981',  // Green
          load: '#6366F1',     // Indigo
          sold: '#059669',     // Green
          returns: '#EF4444',  // Red
          bo: '#F59E0B'        // Amber
        };
        
        // Destroy existing charts before creating new ones
        if (salesOverviewChart) {
          salesOverviewChart.destroy();
          salesOverviewChart = null;
        }
        
        if (inventoryChart) {
          inventoryChart.destroy();
          inventoryChart = null;
        }
        
        // ---- Sales Overview Chart ----
        const salesOverviewCtx = document.getElementById('salesOverviewChart').getContext('2d');
        salesOverviewChart = new Chart(salesOverviewCtx, {
          type: 'bar',
          data: {
            labels: breadData.map(item => item.name),
            datasets: [
              {
                label: 'Quantity Sold',
                data: breadData.map(item => item.netSaleQty),
                backgroundColor: chartColors.sales,
                order: 2,
                yAxisID: 'y'
              },
              {
                label: 'Revenue (‚Ç±)',
                data: breadData.map(item => item.netSaleValue),
                backgroundColor: chartColors.revenue,
                type: 'line',
                order: 1,
                yAxisID: 'y1',
                borderColor: chartColors.revenue,
                pointBackgroundColor: chartColors.revenue,
                tension: 0.1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.dataset.yAxisID === 'y1') {
                      label += '‚Ç±' + context.raw.toFixed(2);
                    } else {
                      label += context.raw;
                      // Add calculated amount for Quantity Sold
                      if (context.dataset.label === 'Quantity Sold') {
                        const breadIndex = context.dataIndex;
                        const bread = breadData[breadIndex];
                        const calculatedAmount = bread.netSaleQty * bread.price;
                        label += `\n(Amount: ‚Ç±${calculatedAmount.toFixed(2)})`;
                      }
                    }
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 60,
                  minRotation: 60,
                  autoSkip: false,
                  callback: function(value, index, values) {
                    // Return the full label without truncation
                    return this.getLabelForValue(value);
                  }
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Quantity'
                }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: {
                  drawOnChartArea: false
                },
                title: {
                  display: true,
                  text: 'Revenue (‚Ç±)'
                },
                ticks: {
                  callback: value => '‚Ç±' + value
                }
              }
            }
          }
        });
        
        // ---- Inventory Management Chart ----
        const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
        inventoryChart = new Chart(inventoryCtx, {
          type: 'bar',
          data: {
            labels: breadData.map(item => item.name),
            datasets: [
              {
                label: 'Initial Load',
                data: breadData.map(item => item.load),
                backgroundColor: chartColors.load
              },
              {
                label: 'Sold',
                data: breadData.map(item => item.netSaleQty),
                backgroundColor: chartColors.sold
              },
              {
                label: 'Returns',
                data: breadData.map(item => item.returned),
                backgroundColor: chartColors.returns
              },
              {
                label: 'B.O.',
                data: breadData.map(item => item.bo),
                backgroundColor: chartColors.bo
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.raw + ' pcs';
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 60,
                  minRotation: 60,
                  autoSkip: false,
                  callback: function(value, index, values) {
                    // Return the full label without truncation
                    return this.getLabelForValue(value);
                  }
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Quantity (pcs)'
                }
              }
            }
          }
        });
        
        showStatus("Charts updated successfully");
      } catch (error) {
        console.error("Chart rendering error:", error);
        showStatus(`Chart error: ${error.message}`, true);
      }
    }

    // Helper functions remain largely unchanged
    function generateColors(count) {
      const baseColors = [
        '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', 
        '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#06B6D4',
        '#84CC16', '#A855F7', '#D946EF', '#265DAB', '#059669'
      ];
      
      if (count <= baseColors.length) {
        return baseColors.slice(0, count);
      }
      
      const colors = [];
      for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
      }
      return colors;
    }

    function prettyPrintCSVTable(csv) {
      const rows = csv.trim().split("\n").map(row => row.split(','));
      return generateTable(rows);
    }

         function generateTable(data) {
       if (data.length === 0) return "<p>No data available</p>";
       
       function formatItemsList(items) {
         if (!items) return '';
         return items;
       }
       
       let thead = `<thead><tr>${data[0].map(h => `<th>${escapeHTML(h)}<div class="resizer"></div></th>`).join("")}</tr></thead>`;
       let tbody = data.slice(1).map(row => {
         return `<tr>${row.map((cell, index) => {
           if (data[0][index] === 'Items Purchased' || data[0][index] === 'Returns') {
             return `<td>${cell ? formatItemsList(cell) : ''}</td>`;
           }
           return `<td>${escapeHTML(cell)}</td>`;
         }).join('')}</tr>`;
       }).join('');
       
       // Add a total row for sales data if there's an Amount column
       const amountColIndex = data[0].findIndex(header => header.includes('Amount'));
       
       // More precisely identify if this is customer sales data (vs inventory data)
       // by checking for headers that only appear in customer sales
       const isCustomerSalesData = data[0].some(header => 
         ["Customer", "Payment Method", "Items Purchased"].includes(header)
       );
       
       // Only add total row for Customer Sales data
       if (amountColIndex !== -1 && isCustomerSalesData) {
         // Calculate total amount from the data
         let totalAmount = 0;
         data.slice(1).forEach(row => {
           if (row[amountColIndex]) {
             // Extract numeric value from the amount (remove ‚Ç± and commas)
             const amountStr = row[amountColIndex].replace('‚Ç±', '').replace(/,/g, '').trim();
             const amount = parseFloat(amountStr);
             if (!isNaN(amount)) {
               totalAmount += amount;
             }
           }
         });
         
         // Create total row
         const totalRow = Array(data[0].length).fill('');
         totalRow[0] = 'TOTAL';
         totalRow[amountColIndex] = `‚Ç±${totalAmount.toFixed(2)}`;
         
         // Add total row to tbody
         tbody += `<tr style="font-weight: bold; background-color: #f0f4f8;">${
           totalRow.map((cell, index) => `<td>${cell}</td>`).join('')
         }</tr>`;
       }
       
       return `<table>${thead}<tbody>${tbody}</tbody></table>`;
     }

           // New function specifically for sales data with customer name toggle
      function generateSalesTable(data) {
        if (data.length === 0) return "<p>No data available</p>";
        
        // Check if the checkbox exists, default to false (show only store names) if it doesn't
        const showCustomerNamesCheckbox = document.getElementById('showCustomerNames');
        console.log('showCustomerNamesCheckbox:', showCustomerNamesCheckbox);
        const showCustomerNames = showCustomerNamesCheckbox ? showCustomerNamesCheckbox.checked : false;
        console.log('showCustomerNames:', showCustomerNames);
        
        function formatItemsList(items) {
          if (!items) return '';
          return items;
        }
        
        // Process headers - replace "Customer" with "Store" if customer names are hidden
        const headers = data[0].map(header => {
          if (header === 'Customer') {
            return showCustomerNames ? 'Store (Customer)' : 'Store';
          }
          return header;
        });
        
        let thead = `<thead><tr>${headers.map(h => `<th>${escapeHTML(h)}<div class="resizer"></div></th>`).join("")}</tr></thead>`;
        
        let tbody = data.slice(1).map(row => {
          return `<tr>${row.map((cell, index) => {
            const header = data[0][index];
            
            if (header === 'Items Purchased' || header === 'Returns') {
              return `<td>${cell ? formatItemsList(cell) : ''}</td>`;
            }
            
            // Handle customer column formatting
            if (header === 'Customer') {
              if (!cell) return '<td></td>';
              
              // Parse the customer cell to extract store name and customer name
              // Format should be: "Customer Name (Store Name)" - we want to show "Store Name (Customer Name)" when toggled
              let displayText = cell;
              
              if (showCustomerNames) {
                // Show both: "Store Name (Customer Name)"
                if (cell.includes('(') && cell.includes(')')) {
                  // Extract customer name and store name from "Customer Name (Store Name)"
                  const match = cell.match(/^(.+?)\s*\((.+?)\)$/);
                  if (match) {
                    const customerName = match[1].trim();
                    const storeName = match[2].trim();
                    displayText = `${storeName} (${customerName})`;
                  }
                } else if (cell.includes(' - ')) {
                  const [customerName, storeName] = cell.split(' - ');
                  displayText = `${storeName.trim()} (${customerName.trim()})`;
                } else if (cell.includes('|')) {
                  const [customerName, storeName] = cell.split('|');
                  displayText = `${storeName.trim()} (${customerName.trim()})`;
                }
              } else {
                // Show only store name (extract from parentheses)
                if (cell.includes('(') && cell.includes(')')) {
                  const match = cell.match(/^(.+?)\s*\((.+?)\)$/);
                  if (match) {
                    displayText = match[2].trim(); // Extract store name from parentheses
                  }
                } else if (cell.includes(' - ')) {
                  displayText = cell.split(' - ')[1]?.trim() || cell;
                } else if (cell.includes('|')) {
                  displayText = cell.split('|')[1]?.trim() || cell;
                }
              }
              
              return `<td>${escapeHTML(displayText)}</td>`;
            }
            
            return `<td>${escapeHTML(cell)}</td>`;
          }).join('')}</tr>`;
        }).join('');
        
        // Add total row for sales data
        const amountColIndex = data[0].findIndex(header => header.includes('Amount'));
        if (amountColIndex !== -1) {
          let totalAmount = 0;
          data.slice(1).forEach(row => {
            if (row[amountColIndex]) {
              const amountStr = row[amountColIndex].replace('‚Ç±', '').replace(/,/g, '').trim();
              const amount = parseFloat(amountStr);
              if (!isNaN(amount)) {
                totalAmount += amount;
              }
            }
          });
          
          const totalRow = Array(headers.length).fill('');
          totalRow[0] = 'TOTAL';
          totalRow[amountColIndex] = `‚Ç±${totalAmount.toFixed(2)}`;
          
          tbody += `<tr style="font-weight: bold; background-color: #f0f4f8;">${
            totalRow.map((cell, index) => `<td>${cell}</td>`).join('')
          }</tr>`;
        }
        
        return `<table>${thead}<tbody>${tbody}</tbody></table>`;
      }

    function toggleContent(btn) {
      const cell = btn.parentElement;
      const preview = cell.querySelector('.preview-content');
      const full = cell.querySelector('.full-content');
      
      if (full.style.display === 'none') {
        preview.style.display = 'none';
        full.style.display = 'block';
        btn.textContent = 'Show Less';
      } else {
        preview.style.display = 'block';
        full.style.display = 'none';
        btn.textContent = 'Show More';
      }
    }

    function parseCSVStringToArray(str) {
      const lines = str.trim().split("\n");
      return lines.map(line => {
        return line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)?.map(val =>
          val.replace(/^"|"$/g, "")
        ) || [];
      });
    }

    function escapeHTML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }



    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;

        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        document.querySelectorAll(".tab-content").forEach(content => {
          content.classList.remove("active");
          if (content.id === target) content.classList.add("active");
        });

        document.querySelectorAll('.copy-button').forEach(b => {
          b.style.display = (b.dataset.tab === target && target !== 'charts') ? 'inline-block' : 'none';
        });
        
        // Show/hide sales download button and toggle switch
        const salesDownloadBtn = document.querySelector('.copy-button[data-tab="sales"]');
        const salesToggleSwitch = document.querySelector('.toggle-switch[data-tab="sales"]');
        
        if (salesDownloadBtn) {
          salesDownloadBtn.style.display = (target === 'sales') ? 'inline-block' : 'none';
        }
        if (salesToggleSwitch) {
          salesToggleSwitch.style.display = (target === 'sales') ? 'inline-flex' : 'none';
        }
      });
    });

         document.querySelectorAll('.copy-button').forEach(btn => {
       btn.addEventListener('click', () => {
         const tab = btn.dataset.tab;
         let html;
         
         if (tab === 'sales') {
           html = document.getElementById('salesTableContent').querySelector('table');
         } else {
           html = document.getElementById(tab + 'Content').querySelector('table');
         }
 
         if (!html) return alert("No table to download.");
 
         let text = "";
         html.querySelectorAll("tr").forEach(row => {
           const cells = row.querySelectorAll("th, td");
           text += [...cells].map(cell => `"${cell.innerText}"`).join(",") + "\n";
         });
 
         // For sales data, append expenses if available
         if (tab === 'sales' && window.currentExpensesData && window.currentExpensesData.length > 0) {
           // Add a blank line
           text += "\n";
           
           // Add Expenses header with proper CSV formatting
           text += '"Expenses",,,,,,\n';
           
           // Add expense columns header with proper CSV formatting
           text += '"Title","Amount","Notes",,,,\n';
           
           // Add each expense with proper CSV escaping
           window.currentExpensesData.forEach(expense => {
             // Escape any double quotes in the text by doubling them
             const escapedTitle = (expense.title || '').replace(/"/g, '""');
             const escapedNote = (expense.note || '').replace(/"/g, '""');
             const escapedAmount = (expense.amount || '').replace(/"/g, '""');
             
             // Format the row with proper CSV escaping
             text += `"${escapedTitle}","${escapedAmount}","${escapedNote}",,,,\n`;
           });
         }
 
         // Generate filename with selected date and tab name
         const selectedDate = dateSelect.value;
         if (!selectedDate) {
           alert("Please select a date first.");
           return;
         }
         
         // Clean naming convention: CSV_date or Sales_date
         const tabName = tab === 'csv' ? 'CSV ' : 'Sales ';
         const filename = `${tabName}_ ${formatDateForFilename(selectedDate)}.txt`;
         
         // Call download function
         downloadTextFile(text, filename);
       });
     });

    // Function to handle file download
    function downloadTextFile(content, filename) {
      // Create a blob with the text content
      const blob = new Blob([content], { type: 'text/plain' });
      
      // Create a URL for the blob
      const url = URL.createObjectURL(blob);
      
      // Create a temporary link element
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      
      // Append to the document
      document.body.appendChild(link);
      
      // Trigger download
      link.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showStatus(`Downloaded ${filename} successfully`);
      }, 100);
    }

         document.addEventListener('DOMContentLoaded', function() {
       showStatus("Starting application...");
       setupCopyNamingButton();
       
       // Add event listener for customer name toggle
       const showCustomerNamesCheckbox = document.getElementById('showCustomerNames');
       if (showCustomerNamesCheckbox) {
         showCustomerNamesCheckbox.addEventListener('change', function() {
           console.log('Customer names toggle changed to:', this.checked);
           // Refresh sales table if it exists
           if (window.currentSalesData) {
             document.getElementById('salesTableContent').innerHTML = generateSalesTable(window.currentSalesData);
             setupTableResizing();
           }
         });
       }
      
      console.log("Appwrite config:", {
        endpoint: 'https://cloud.appwrite.io/v1',
        projectId: '676a55320025aab57b76',
        databaseId: databaseId,
        csvCollection: csvCollection,
        salesCollection: salesCollection
      });
      
      testAppwriteConnection().then(success => {
        if (success) {
          getAvailableDates();
        } else {
          showStatus("Connection to Appwrite failed.", true);
        }
      });

      // Test customer database connection
      testCustomerConnection();
    });

    async function testAppwriteConnection() {
      try {
        showStatus("Testing Appwrite connection...");
        const health = await databases.listDocuments(databaseId, csvCollection, [
          Appwrite.Query.limit(1)
        ]);
        console.log("Database connection successful:", health);
        showStatus("Appwrite connection successful!");
        return true;
      } catch (error) {
        console.error("Database connection failed:", error);
        
        if (error.message?.includes('Failed to fetch')) {
          showStatus(`CORS Error: Please access this page through a web server (http://localhost:8080) instead of directly opening the file.`, true);
        } else {
          showStatus(`Appwrite connection failed: ${error.message}`, true);
        }
        return false;
      }
    }
    
    testAppwriteConnection();

    // Add this new function for table column resizing
    function setupTableResizing() {
      document.querySelectorAll('th').forEach(th => {
        const resizer = th.querySelector('.resizer');
        let startX, startWidth;

        resizer.addEventListener('mousedown', (e) => {
          startX = e.pageX;
          startWidth = th.offsetWidth;
          
          document.addEventListener('mousemove', resize);
          document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
          const width = startWidth + (e.pageX - startX);
          th.style.width = width + 'px';
        }

        function stopResize() {
          document.removeEventListener('mousemove', resize);
          document.removeEventListener('mouseup', stopResize);
        }
      });
    }

    // Customer database connection test and data loading
    async function testCustomerConnection() {
      try {
        showStatus("Testing customer database connection...");
        const success = await customerService.testConnection();
        if (success) {
          showStatus("Customer database connection successful!");
          // Load customers after successful connection
          await loadCustomers();
        } else {
          showStatus("Customer database connection failed.", true);
          document.getElementById('customerGrid').innerHTML = '<p style="text-align: center; color: #DC2626; font-weight: bold;">‚ùå Customer database connection failed</p>';
        }
      } catch (error) {
        console.error("Customer connection test error:", error);
        showStatus(`Customer database connection error: ${error.message}`, true);
        document.getElementById('customerGrid').innerHTML = '<p style="text-align: center; color: #DC2626; font-weight: bold;">‚ùå Connection error: ${error.message}</p>';
      }
    }

    // Load customers with progress updates
    async function loadCustomers() {
      try {
        const customerGrid = document.getElementById('customerGrid');
        customerGrid.innerHTML = '<div class="loading">Loading customers...</div>';
        
        const customers = await customerService.getCustomers((message, count) => {
          // Update progress
          customerGrid.innerHTML = `<div class="loading">${message}</div>`;
          showStatus(message);
        });
        
        if (customers.length === 0) {
          customerGrid.innerHTML = '<p style="text-align: center; color: #6b7280;">No customers found.</p>';
          showStatus("No customers found.");
          return;
        }

        // Store all customers globally and sort them properly
        allCustomers = sortCustomers(customers, 'storeName');

        displayCustomers(allCustomers);
        showStatus(`Loaded ${allCustomers.length} customers successfully`);
        
        // Setup search functionality
        setupCustomerSearch();
      } catch (error) {
        console.error("Error loading customers:", error);
        document.getElementById('customerGrid').innerHTML = '<p style="text-align: center; color: #DC2626; font-weight: bold;">‚ùå Error loading customers: ' + error.message + '</p>';
        showStatus(`Error loading customers: ${error.message}`, true);
      }
    }

    // Display customers in grid layout
    function displayCustomers(customers) {
      const customerGrid = document.getElementById('customerGrid');
      
      if (customers.length === 0) {
        customerGrid.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;"><p>No customers found matching your search.</p><p style="font-size: 14px; margin-top: 8px;">Try adjusting your search terms or clearing the search.</p></div>';
        return;
      }
      
      const customerCards = customers.map((customer, index) => {
        const customerKey = `${customer.customerName}|${customer.storeName}`;
        // Safely encode the customer key to prevent JavaScript injection
        const safeCustomerKey = encodeURIComponent(customerKey);
        return `
          <div class="customer-card" data-customer-key="${safeCustomerKey}" data-customer-index="${index}">
            <div class="customer-header">
              <h3>${escapeHTML(customer.storeName)}</h3>
              <span class="customer-name">${escapeHTML(customer.customerName)}</span>
            </div>
            <div class="customer-info">
              <div class="info-item">
                <span class="info-value">${customer.receiptCount}</span>
                <span class="info-label">Receipts</span>
              </div>
            </div>
            <div class="customer-footer">
              <span class="click-hint">Click to view receipt history</span>
            </div>
          </div>
        `;
      }).join('');

      customerGrid.innerHTML = customerCards;
      
      // Add click event listeners to customer cards
      const customerCardsElements = customerGrid.querySelectorAll('.customer-card');
      customerCardsElements.forEach(card => {
        card.addEventListener('click', function() {
          const encodedCustomerKey = this.getAttribute('data-customer-key');
          if (encodedCustomerKey) {
            try {
              const customerKey = decodeURIComponent(encodedCustomerKey);
              console.log('Customer card clicked:', customerKey);
              showCustomerReceipts(customerKey);
            } catch (error) {
              console.error('Error showing customer receipts:', error);
              alert('Error loading customer receipts. Please try again.');
            }
          }
        });
      });
    }
    
    // Setup customer search functionality
    function setupCustomerSearch() {
      const searchInput = document.getElementById('customerSearch');
      const clearSearchBtn = document.getElementById('clearSearch');
      const searchResultsCount = document.getElementById('searchResultsCount');
      
      if (!searchInput) return;
      
      // Search function with debouncing
      let searchTimeout;
      function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        if (searchTerm === '') {
          // Show all customers when search is empty
          displayCustomers(allCustomers);
          clearSearchBtn.style.display = 'none';
          updateSearchResultsCount(allCustomers.length, '');
          return;
        }
        
        // Filter customers by store name or customer name
        const filteredCustomers = allCustomers.filter(customer => {
          const storeNameMatch = customer.storeName.toLowerCase().includes(searchTerm);
          const customerNameMatch = customer.customerName.toLowerCase().includes(searchTerm);
          return storeNameMatch || customerNameMatch;
        });
        
        // Sort filtered results to maintain consistent ordering
        const sortedFilteredCustomers = sortCustomers(filteredCustomers, 'storeName');
        
        // Display filtered results
        displayCustomers(sortedFilteredCustomers);
        
        // Update UI
        clearSearchBtn.style.display = 'inline-block';
        updateSearchResultsCount(sortedFilteredCustomers.length, searchTerm);
      }
      
      // Debounced search function
      function debouncedSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      }
      
      // Event listeners
      searchInput.addEventListener('input', debouncedSearch);
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchInput.value = '';
          performSearch();
          searchInput.blur();
        }
      });
      
      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        performSearch();
        searchInput.focus();
      });
      
      // Initialize search results count
      updateSearchResultsCount(allCustomers.length, '');
      
      // Add search input placeholder animation
      let placeholderIndex = 0;
      const placeholders = [
        'Search by store name or customer name...',
        'Try "Store ABC" or "John Doe"...',
        'Search is case-insensitive...'
      ];
      
      setInterval(() => {
        placeholderIndex = (placeholderIndex + 1) % placeholders.length;
        searchInput.placeholder = placeholders[placeholderIndex];
      }, 3000);
    }
    
    // Function to refresh search results count
    function updateSearchResultsCount(filteredCount, searchTerm = '') {
      const searchResultsCount = document.getElementById('searchResultsCount');
      if (searchResultsCount) {
        if (searchTerm === '') {
          searchResultsCount.textContent = `Showing all ${allCustomers.length} customers`;
        } else {
          searchResultsCount.textContent = `Found ${filteredCount} customer${filteredCount !== 1 ? 's' : ''} matching "${searchTerm}"`;
        }
      }
    }
    
    // Function to sort customers by different criteria
    function sortCustomers(customers, sortBy = 'storeName') {
      const sortedCustomers = [...customers];
      
      switch (sortBy) {
        case 'storeName':
          sortedCustomers.sort((a, b) => {
            const storeNameComparison = a.storeName.localeCompare(b.storeName);
            if (storeNameComparison !== 0) return storeNameComparison;
            return a.customerName.localeCompare(b.customerName);
          });
          break;
        case 'customerName':
          sortedCustomers.sort((a, b) => {
            const customerNameComparison = a.customerName.localeCompare(b.customerName);
            if (customerNameComparison !== 0) return customerNameComparison;
            return a.storeName.localeCompare(b.storeName);
          });
          break;
        case 'receiptCount':
          sortedCustomers.sort((a, b) => b.receiptCount - a.receiptCount);
          break;
        default:
          // Default to store name sorting
          sortedCustomers.sort((a, b) => {
            const storeNameComparison = a.storeName.localeCompare(b.storeName);
            if (storeNameComparison !== 0) return storeNameComparison;
            return a.customerName.localeCompare(b.customerName);
          });
      }
      
      return sortedCustomers;
    }

    // Helper function to parse CSV string into array
    function parseCSVItems(csvString) {
      if (!csvString || csvString.trim() === '') return [];
      
      try {
        const sanitizeNumber = (value) => {
          if (value === undefined || value === null) return 0;
          const cleaned = String(value).replace(/‚Ç±/g, '').replace(/,/g, '').trim();
          const num = parseFloat(cleaned);
          return isNaN(num) ? 0 : num;
        };

        // Split by lines and then by commas
        const lines = csvString.trim().split('\n');
        return lines.map(line => {
          const parts = line.split(',').map(part => part.trim());
          const itemName = parts[0] || '';
          const amountStr = parts[1];
          const priceStr = parts[2];
          // CSV structures we support:
          // 1) item,amount,price,total  -> use total (index 3) and ignore price
          // 2) item,amount,total        -> legacy, third value is total
          // 3) item,amount,price        -> compute total = amount * price
          // 4) item,amount              -> total = 0
          let totalValue = 0;
          if (parts.length >= 4) {
            totalValue = sanitizeNumber(parts[3]);
            if (totalValue === 0) {
              // Fallback to compute if provided total is empty/zero but price exists
              totalValue = sanitizeNumber(amountStr) * sanitizeNumber(priceStr);
            }
          } else if (parts.length === 3) {
            // If length is 3, decide whether 3rd is price or total by checking names not possible here
            // Prefer treating 3rd column as total when it's clearly an amount
            const maybeTotal = sanitizeNumber(parts[2]);
            const qty = sanitizeNumber(amountStr);
            const price = sanitizeNumber(priceStr);
            // Heuristic: if qty*price equals maybeTotal (or price looks like unit price), keep maybeTotal; else compute
            const computed = qty * price;
            totalValue = (computed > 0 && Math.abs(computed - maybeTotal) < 0.005) ? maybeTotal : (price > 0 ? computed : maybeTotal);
          } else if (parts.length === 2) {
            totalValue = 0;
          }
          return {
            item: itemName,
            quantity: (amountStr ?? '0'),
            total: totalValue
          };
        });
      } catch (error) {
        console.error('Error parsing CSV items:', error);
        return [];
      }
    }

    // Helper function to calculate total from CSV items
    function calculateItemsTotal(csvString) {
      const items = parseCSVItems(csvString);
      return items.reduce((sum, item) => sum + parseFloat(item.total || 0), 0);
    }

    // Show customer receipt history
    window.showCustomerReceipts = function(customerKey) {
      try {
        const receipts = customerService.getCustomerReceiptHistory(customerKey);
        const [customerName, storeName] = customerKey.split('|');
        
        if (receipts.length === 0) {
          alert('No receipt history found for this customer.');
          return;
        }
        
        // Update modal title
        document.getElementById('modalTitle').textContent = `Receipt History - ${storeName}`;
        
        // Create modal content
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
          <div class="receipt-list">
            ${receipts.map((receipt, index) => {
              // Parse order and return items
              const orderItems = parseCSVItems(receipt.orderItem);
              const returnItems = parseCSVItems(receipt.returnItem);
              
              // Calculate totals
              const orderTotal = calculateItemsTotal(receipt.orderItem);
              const returnTotal = calculateItemsTotal(receipt.returnItem);
              // Calculate final total as order total minus return total
              const finalTotal = orderTotal - returnTotal;
              
              return `
                <div class="receipt-item" data-receipt-index="${index}">
                  <div class="receipt-header">
                    <span class="receipt-date">Receipt #${index + 1} - ${formatDate(receipt.date)}</span>
                    <span class="receipt-amount ${finalTotal < 0 ? 'negative' : ''}">‚Ç±${finalTotal.toFixed(2)}</span>
                  </div>
                  
                  <div class="receipt-details">
                    <div class="detail-item">
                      <span class="detail-label">Receipt ID</span>
                      <span class="detail-value">${receipt.receiptId || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Payment Method</span>
                      <span class="detail-value">${receipt.paymentMethod || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Date</span>
                      <span class="detail-value">${formatDate(receipt.date)}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Time</span>
                      <span class="detail-value">${receipt.time || 'N/A'}</span>
                    </div>
                  </div>
                  
                  <div class="expandable-content" id="receipt-${index}">
                                         ${orderItems.length > 0 ? `
                       <div class="receipt-items order-section">
                         <div class="items-label">üì¶ Order Items</div>
                         <div class="items-list">
                           ${orderItems.map(item => `
                             <div class="item-row">
                               <span class="item-name">${item.item}</span>
                               <span class="item-qty">${item.quantity}</span>
                               <span class="item-total">‚Ç±${parseFloat(item.total).toFixed(2)}</span>
                             </div>
                           `).join('')}
                         </div>
                       </div>
                     ` : ''}
                     
                     ${returnItems.length > 0 ? `
                       <div class="receipt-items return-section">
                         <div class="items-label">üîÑ Return Items</div>
                         <div class="items-list">
                           ${returnItems.map(item => `
                             <div class="item-row">
                               <span class="item-name">${item.item}</span>
                               <span class="item-qty">${item.quantity}</span>
                               <span class="item-total">‚Ç±${parseFloat(item.total).toFixed(2)}</span>
                             </div>
                           `).join('')}
                         </div>
                       </div>
                     ` : ''}
                    
                    <div class="receipt-totals">
                      ${orderItems.length > 0 ? `
                        <div class="totals-row">
                          <span class="totals-label">Order Total:</span>
                          <span class="totals-value">‚Ç±${orderTotal.toFixed(2)}</span>
                        </div>
                      ` : ''}
                      
                      ${returnItems.length > 0 ? `
                        <div class="totals-row">
                          <span class="totals-label">Return Total:</span>
                          <span class="totals-value">‚Ç±${returnTotal.toFixed(2)}</span>
                        </div>
                      ` : ''}
                      
                      <div class="totals-row">
                        <span class="totals-label">Final Total:</span>
                        <span class="totals-value ${finalTotal < 0 ? 'negative' : ''}">‚Ç±${finalTotal.toFixed(2)}</span>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        // Show modal
        document.getElementById('receiptModal').style.display = 'flex';
        
        // Add event listeners to receipt items
        const receiptItems = document.querySelectorAll('.receipt-item');
        receiptItems.forEach(item => {
          item.addEventListener('click', function() {
            const receiptIndex = this.getAttribute('data-receipt-index');
            if (receiptIndex !== null) {
              toggleReceiptExpansion(parseInt(receiptIndex));
            }
          });
        });
        
      } catch (error) {
        console.error("Error showing customer receipts:", error);
        alert("Error loading receipt history");
      }
    };

         // Toggle receipt expansion
     window.toggleReceiptExpansion = function(index) {
       const content = document.getElementById(`receipt-${index}`);
       const receiptItem = content.closest('.receipt-item');
       
       if (content.classList.contains('expanded')) {
         content.classList.remove('expanded');
         receiptItem.classList.remove('expanded');
       } else {
         content.classList.add('expanded');
         receiptItem.classList.add('expanded');
       }
     };

    // Close receipt modal
    window.closeReceiptModal = function() {
      document.getElementById('receiptModal').style.display = 'none';
    };

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('receiptModal');
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeReceiptModal();
        }
      });
    });

    // Helper function to format date
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString();
      } catch (error) {
        return dateString;
      }
    }
  </script>
</body>
</html>